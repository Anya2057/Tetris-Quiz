<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Neon Tetris Quiz Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --bg-dark: #0a0e27;
            --bg-gradient-start: #0a0e27;
            --bg-gradient-end: #1a1f3a;
            --panel-bg: rgba(15, 23, 42, 0.7);
            --panel-border: rgba(56, 189, 248, 0.2);
            
            --neon-cyan: #00ffff;
            --neon-pink: #ff00ff;
            --neon-purple: #bf00ff;
            --neon-blue: #0080ff;
            --neon-green: #00ff88;
            
            --accent-primary: #38bdf8;
            --accent-secondary: #818cf8;
            --accent-success: #22d3ee;
            --accent-danger: #f43f5e;
            --accent-warning: #fbbf24;
            
            --text-bright: #ffffff;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --text-dark: #475569;
            
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            position: relative;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω —Å–æ –∑–≤–µ–∑–¥–∞–º–∏ */
        canvas#bg-stars {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            opacity: 0.6;
        }

        /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –≥–ª—É–±–∏–Ω—ã */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 50% 50%, transparent 0%, rgba(10, 14, 39, 0.8) 100%);
            z-index: 1;
            pointer-events: none;
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º glassmorphism */
        #game-wrapper {
            display: flex;
            gap: 24px;
            padding: 32px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 32px;
            border: 2px solid var(--panel-border);
            box-shadow: 
                0 0 80px rgba(56, 189, 248, 0.15),
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 10;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Ç—Ä—è—Å–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        /* –ö–∞–Ω–≤–∞—Å –∏–≥—Ä—ã —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º */
        canvas#tetris {
            background: 
                linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(10, 14, 39, 0.9) 100%);
            border-radius: 16px;
            border: 2px solid var(--panel-border);
            box-shadow: 
                inset 0 0 40px rgba(0, 0, 0, 0.6),
                0 0 40px rgba(56, 189, 248, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.03);
            position: relative;
        }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .side-panel {
            width: 240px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ */
        .panel-box {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--panel-border);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .panel-box::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 0%, rgba(56, 189, 248, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .panel-box:hover::before {
            opacity: 1;
        }

        /* –ú–µ—Ç–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .label {
            font-size: 12px;
            font-weight: 700;
            font-family: var(--font-display);
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(148, 163, 184, 0.3);
        }

        /* –ó–Ω–∞—á–µ–Ω–∏—è —Å –Ω–µ–æ–Ω–æ–≤—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º */
        .value {
            font-size: 36px;
            font-weight: 900;
            font-family: var(--font-display);
            color: var(--neon-cyan);
            text-shadow: 
                0 0 10px rgba(0, 255, 255, 0.8),
                0 0 20px rgba(0, 255, 255, 0.6),
                0 0 30px rgba(0, 255, 255, 0.4),
                0 0 40px rgba(0, 255, 255, 0.2);
            animation: neonPulse 2s ease-in-out infinite;
        }

        @keyframes neonPulse {
            0%, 100% { 
                text-shadow: 
                    0 0 10px rgba(0, 255, 255, 0.8),
                    0 0 20px rgba(0, 255, 255, 0.6),
                    0 0 30px rgba(0, 255, 255, 0.4);
            }
            50% { 
                text-shadow: 
                    0 0 15px rgba(0, 255, 255, 1),
                    0 0 30px rgba(0, 255, 255, 0.8),
                    0 0 45px rgba(0, 255, 255, 0.6),
                    0 0 60px rgba(0, 255, 255, 0.4);
            }
        }

        /* –ö–∞–Ω–≤–∞—Å –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∏–≥—É—Ä—ã */
        #next-container {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas#next {
            filter: drop-shadow(0 0 15px rgba(56, 189, 248, 0.3));
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .key-btn {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border-radius: 12px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 3px solid #0f172a;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .key-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .key-btn:hover::before {
            opacity: 1;
        }

        .key-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 189, 248, 0.3);
        }

        .key-btn:active {
            transform: translateY(1px);
            border-bottom-width: 1px;
        }

        .key-btn span {
            font-size: 20px;
            color: var(--text-bright);
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }

        .btn {
            border: none;
            padding: 14px 20px;
            border-radius: 14px;
            font-weight: 700;
            font-size: 14px;
            font-family: var(--font-display);
            cursor: pointer;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid transparent;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-menu {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .btn-menu:hover {
            box-shadow: 0 6px 20px rgba(56, 189, 248, 0.3);
            border-color: var(--accent-primary);
        }

        .btn-exit {
            background: linear-gradient(135deg, #f43f5e 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4);
        }

        .btn-exit:hover {
            box-shadow: 0 6px 25px rgba(244, 63, 94, 0.6);
        }

        .btn-primary {
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
            color: #0f172a;
            box-shadow: 
                0 4px 20px rgba(56, 189, 248, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            font-weight: 900;
        }

        .btn-primary:hover {
            box-shadow: 
                0 6px 30px rgba(56, 189, 248, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--panel-border);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
            background: rgba(56, 189, 248, 0.1);
        }

        /* –û–≤–µ—Ä–ª–µ–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(2, 6, 23, 0.97);
            backdrop-filter: blur(10px);
            border-radius: 32px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: all;
            animation: overlaySlideIn 0.4s ease-out;
        }

        @keyframes overlaySlideIn {
            from {
                transform: scale(0.95);
            }
            to {
                transform: scale(1);
            }
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        h1 {
            margin: 0 0 16px 0;
            font-size: 48px;
            font-family: var(--font-display);
            font-weight: 900;
            background: linear-gradient(135deg, var(--neon-cyan) 0%, var(--neon-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
            animation: titleGlow 3s ease-in-out infinite;
            letter-spacing: 2px;
        }

        @keyframes titleGlow {
            0%, 100% {
                filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.6));
            }
            50% {
                filter: drop-shadow(0 0 40px rgba(191, 0, 255, 0.8));
            }
        }

        h2 {
            color: var(--text-bright);
            margin-bottom: 24px;
            font-weight: 600;
            font-size: 24px;
            font-family: var(--font-body);
        }

        p {
            color: var(--text-muted);
            margin-bottom: 32px;
            font-size: 16px;
            font-weight: 300;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 14px;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 32px;
            font-weight: 300;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–≤–∏–∑–∞ */
        .quiz-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .quiz-opt {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 2px solid rgba(56, 189, 248, 0.2);
            padding: 20px 24px;
            border-radius: 16px;
            color: var(--text-main);
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .quiz-opt::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .quiz-opt:hover {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.15) 0%, rgba(30, 41, 59, 0.9) 100%);
            border-color: var(--accent-primary);
            transform: translateX(8px);
            box-shadow: 
                0 8px 32px rgba(56, 189, 248, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .quiz-opt:hover::before {
            opacity: 1;
        }

        .quiz-opt:active {
            transform: translateX(4px) scale(0.98);
        }

        /* –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é */
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 300px;
        }

        .menu-btn-large {
            padding: 20px 32px;
            font-size: 16px;
            border-radius: 16px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
        .result-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            width: 100%;
            max-width: 400px;
            margin: 24px 0;
        }

        .stat-item {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        /* –£—Ç–∏–ª–∏—Ç—ã */
        .hidden {
            display: none !important;
        }

        .text-success {
            color: var(--accent-success);
        }

        .text-danger {
            color: var(--accent-danger);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            #game-wrapper {
                flex-direction: column;
                padding: 20px;
            }

            .side-panel {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }

            .panel-box {
                flex: 1;
                min-width: 120px;
            }

            h1 {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>

<canvas id="bg-stars"></canvas>

<div id="game-wrapper">
    <canvas id="tetris" width="360" height="600"></canvas>

    <div class="side-panel">
        <div class="panel-box">
            <div class="label">–°–ª–µ–¥—É—é—â–∞—è</div>
            <div id="next-container">
                <canvas id="next" width="120" height="80"></canvas>
            </div>
        </div>

        <div class="panel-box">
            <div class="label">–í—Ä–µ–º—è</div>
            <div id="time-val" class="value">05:00</div>
        </div>

        <div class="panel-box">
            <div class="label">–û—á–∫–∏</div>
            <div id="score-val" class="value">0</div>
        </div>

        <div style="flex-grow: 1;"></div>

        <div class="panel-box" style="padding: 16px;">
            <div class="label" style="margin-bottom: 12px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
            <div class="controls-grid">
                <div></div>
                <div class="key-btn" onclick="input(38)"><span>‚Üª</span></div>
                <div></div>
                <div class="key-btn" onclick="input(37)"><span>‚Üê</span></div>
                <div class="key-btn" onclick="input(40)"><span>‚Üì</span></div>
                <div class="key-btn" onclick="input(39)"><span>‚Üí</span></div>
            </div>
            <div style="margin-top: 12px; font-size: 11px; color: var(--text-muted); text-align: center;">
                –ü–†–û–ë–ï–õ - –±—ã—Å—Ç—Ä—ã–π —Å–±—Ä–æ—Å
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-menu" onclick="resetToMenu()">–ú–µ–Ω—é</button>
            <button class="btn btn-exit" onclick="endGame(false, true)">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <!-- –ú–µ–Ω—é -->
    <div id="menu-overlay" class="overlay active">
        <h1>NEON TETRIS</h1>
        <p class="subtitle">–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞</p>
        <div class="menu-buttons">
            <button class="btn btn-primary menu-btn-large" onclick="startGame('timer')">
                ‚è± –°–ø—Ä–∏–Ω—Ç (5 –º–∏–Ω—É—Ç)
            </button>
            <button class="btn btn-secondary menu-btn-large" onclick="startGame('infinite')">
                ‚ôæ –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º
            </button>
        </div>
    </div>

    <!-- –ö–≤–∏–∑ -->
    <div id="quiz-overlay" class="overlay">
        <div style="width: 100%; max-width: 500px; text-align: left;">
            <div class="label" style="margin-bottom: 12px; text-align: center;">–í–æ–ø—Ä–æ—Å</div>
            <h2 id="q-text" style="margin-top: 0; font-size: 22px; line-height: 1.5; text-align: center;">
                –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞?
            </h2>
        </div>
        <div id="q-options" class="quiz-container"></div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div id="result-overlay" class="overlay">
        <h1 id="res-title">–ü–û–ë–ï–î–ê!</h1>
        <p id="res-desc">–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
        <div class="result-stats">
            <div class="stat-item">
                <div class="label">–ò—Ç–æ–≥–æ–≤—ã–π —Å—á—ë—Ç</div>
                <div id="res-score" class="value">0</div>
            </div>
        </div>
        <button class="btn btn-primary menu-btn-large" onclick="resetToMenu()">–í –º–µ–Ω—é</button>
    </div>
</div>

<script>
/* --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–°–ï–• –ü–ï–†–ï–ú–ï–ù–ù–´–• –°–ù–ê–ß–ê–õ–ê --- */

// –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –î–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
let arena = [];
let player = { pos: {x: 0, y: 0}, matrix: null, score: 0 };
let nextPiece = null;
let dropCounter = 0;
let dropInterval = 800; // 800–º—Å –Ω–∞ –æ–¥–Ω—É –∫–ª–µ—Ç–∫—É - –º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø–ª–∞–≤–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ
let lastTime = 0;
let isPaused = false;
let gameActive = false;
let timerVal = 300;
let timerRef = null;

// –ß–∞—Å—Ç–∏—Ü—ã –¥–ª—è —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–æ–≤
let particles = [];

// –ó–≤–µ–∑–¥—ã –¥–ª—è —Ñ–æ–Ω–∞
let stars = [];

/* --- 1. –ê–£–î–ò–û –î–í–ò–ñ–û–ö (SFX) --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playTone(freq, type, dur, vol=0.1) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
}

const SFX = {
    move: () => playTone(300, 'sine', 0.05, 0.05),
    rotate: () => playTone(400, 'triangle', 0.1, 0.05),
    drop: () => playTone(150, 'sawtooth', 0.1, 0.1),
    clear: () => { 
        playTone(600, 'sine', 0.1, 0.2); 
        setTimeout(() => playTone(800, 'sine', 0.2, 0.2), 100); 
    },
    error: () => { 
        playTone(150, 'sawtooth', 0.3, 0.3); 
        setTimeout(() => playTone(100, 'sawtooth', 0.3, 0.3), 150); 
    },
    win: () => { 
        [523, 659, 783, 1046].forEach((f, i) => 
            setTimeout(() => playTone(f, 'square', 0.3, 0.1), i * 120)
        ); 
    }
};

/* --- 2. –ì–†–ê–§–ò–ö–ê: –ó–í–ï–ó–î–´ –ò –ù–ï–û–ù --- */
const cvs = document.getElementById('tetris');
const ctx = cvs.getContext('2d');
const nextCvs = document.getElementById('next');
const nextCtx = nextCvs.getContext('2d');

// –£–ª—É—á—à–µ–Ω–Ω—ã–µ –Ω–µ–æ–Ω–æ–≤—ã–µ —Ü–≤–µ—Ç–∞
const COLORS = [
    null,
    '#ff0066', // Z - Hot Pink
    '#00ff88', // S - Neon Green
    '#bf00ff', // T - Electric Purple
    '#ffdd00', // O - Electric Yellow
    '#00ddff', // I - Bright Cyan
    '#ff6600', // L - Neon Orange
    '#0066ff'  // J - Electric Blue
];

// –§–æ–Ω: –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∑–≤–µ–∑–¥—ã
const bgCvs = document.getElementById('bg-stars');
const bgCtx = bgCvs.getContext('2d');

function initStars() {
    bgCvs.width = window.innerWidth;
    bgCvs.height = window.innerHeight;
    stars = [];
    for(let i = 0; i < 200; i++) {
        stars.push({
            x: Math.random() * bgCvs.width,
            y: Math.random() * bgCvs.height,
            size: Math.random() * 2 + 0.5,
            speed: Math.random() * 0.5 + 0.1,
            alpha: Math.random() * 0.5 + 0.5,
            twinkleSpeed: Math.random() * 0.02 + 0.01,
            twinklePhase: Math.random() * Math.PI * 2
        });
    }
}

window.onresize = initStars;
initStars();

function drawBackground() {
    bgCtx.clearRect(0, 0, bgCvs.width, bgCvs.height);
    
    stars.forEach(s => {
        // –ú–µ—Ä—Ü–∞–Ω–∏–µ –∑–≤–µ–∑–¥
        s.twinklePhase += s.twinkleSpeed;
        const twinkle = Math.sin(s.twinklePhase) * 0.3 + 0.7;
        
        bgCtx.globalAlpha = s.alpha * twinkle;
        bgCtx.fillStyle = '#ffffff';
        bgCtx.beginPath();
        bgCtx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
        bgCtx.fill();
        
        // –õ–µ–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–≤–µ–∑–¥
        if(s.size > 1.5) {
            bgCtx.globalAlpha = s.alpha * twinkle * 0.3;
            bgCtx.beginPath();
            bgCtx.arc(s.x, s.y, s.size * 2, 0, Math.PI * 2);
            bgCtx.fill();
        }
        
        // –î–≤–∏–∂–µ–Ω–∏–µ –≤–Ω–∏–∑
        s.y += s.speed;
        if(s.y > bgCvs.height) {
            s.y = 0;
            s.x = Math.random() * bgCvs.width;
        }
    });
    
    bgCtx.globalAlpha = 1;
    updateFireworks();
    requestAnimationFrame(drawBackground);
}

drawBackground();

// –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∏
function createFirework(x, y, color) {
    for(let i = 0; i < 30; i++) {
        const angle = (Math.PI * 2 * i) / 30;
        const speed = Math.random() * 6 + 2;
        particles.push({
            x, y, color,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            life: 1.0,
            size: Math.random() * 3 + 1
        });
    }
}

function updateFireworks() {
    for(let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        
        bgCtx.globalAlpha = p.life;
        bgCtx.shadowBlur = 15;
        bgCtx.shadowColor = p.color;
        bgCtx.fillStyle = p.color;
        bgCtx.beginPath();
        bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        bgCtx.fill();
        
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.1; // gravity
        p.life -= 0.015;
        
        if(p.life <= 0) particles.splice(i, 1);
    }
    
    bgCtx.globalAlpha = 1;
    bgCtx.shadowBlur = 0;
}

// –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤ —Å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–º —Å–≤–µ—á–µ–Ω–∏–µ–º
function drawBlock(targetCtx, x, y, colorId, size = 30) {
    if(!colorId) return;
    
    const color = colorId === -1 ? '#475569' : COLORS[colorId];
    const px = x * size;
    const py = y * size;

    // –í–Ω–µ—à–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ (–±–æ–ª–µ–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ)
    targetCtx.shadowBlur = 25;
    targetCtx.shadowColor = color;
    
    // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞ –¥–ª—è –æ–±—ä–µ–º–∞
    const gradient = targetCtx.createLinearGradient(px, py, px + size, py + size);
    gradient.addColorStop(0, color);
    gradient.addColorStop(1, shadeColor(color, -30));
    
    targetCtx.fillStyle = gradient;
    targetCtx.fillRect(px + 2, py + 2, size - 4, size - 4);

    // –°–±—Ä–æ—Å —Ç–µ–Ω–∏
    targetCtx.shadowBlur = 0;
    
    // –í–µ—Ä—Ö–Ω–∏–π –±–ª–∏–∫
    const highlightGradient = targetCtx.createLinearGradient(px, py, px, py + size / 2);
    highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
    highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
    targetCtx.fillStyle = highlightGradient;
    targetCtx.fillRect(px + 2, py + 2, size - 4, size / 2 - 2);
    
    // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –≥–ª—É–±–∏–Ω—ã
    targetCtx.strokeStyle = shadeColor(color, 40);
    targetCtx.lineWidth = 1;
    targetCtx.strokeRect(px + 3, py + 3, size - 6, size - 6);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è/–æ—Å–≤–µ—Ç–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
function shadeColor(color, percent) {
    const num = parseInt(color.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255))
        .toString(16).slice(1);
}

/* --- 3. –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê --- */
const CONFIG = {
    cols: 12,  // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 10 –¥–æ 12 –∫–æ–ª–æ–Ω–æ–∫
    rows: 20,
    questions: [
        { q: "–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è 'Red'?", a: ["–ö—Ä–∞—Å–Ω—ã–π", "–°–∏–Ω–∏–π", "–ó–µ–ª—ë–Ω—ã–π"], c: 0 },
        { q: "–°—Ç–æ–ª–∏—Ü–∞ –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏?", a: ["–õ–æ–Ω–¥–æ–Ω", "–ü–∞—Ä–∏–∂", "–ë–µ—Ä–ª–∏–Ω"], c: 0 },
        { q: "2 + 2 √ó 2 = ?", a: ["8", "6", "4"], c: 1 },
        { q: "–°–ª–æ–≤–æ 'Apple' —ç—Ç–æ:", a: ["–Ø–±–ª–æ–∫–æ", "–ì—Ä—É—à–∞", "–ê–ø–µ–ª—å—Å–∏–Ω"], c: 0 },
        { q: "–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª–µ?", a: ["7", "5", "6"], c: 0 },
        { q: "–ö–∞–∫–æ–π –≥–∞–∑ –º—ã –≤–¥—ã—Ö–∞–µ–º?", a: ["–ö–∏—Å–ª–æ—Ä–æ–¥", "–£–≥–ª–µ–∫–∏—Å–ª—ã–π –≥–∞–∑", "–ê–∑–æ—Ç"], c: 0 },
        { q: "–°–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –ó–µ–º–ª–µ?", a: ["5", "6", "7"], c: 2 },
        { q: "–ö–∞–∫–æ–π —Ü–≤–µ—Ç –ø–æ–ª—É—á–∏—Ç—Å—è –µ—Å–ª–∏ —Å–º–µ—à–∞—Ç—å —Å–∏–Ω–∏–π –∏ –∂—ë–ª—Ç—ã–π?", a: ["–ó–µ–ª—ë–Ω—ã–π", "–§–∏–æ–ª–µ—Ç–æ–≤—ã–π", "–û—Ä–∞–Ω–∂–µ–≤—ã–π"], c: 0 },
        { q: "10 √ó 10 = ?", a: ["100", "110", "90"], c: 0 },
        { q: "–ü–ª–∞–Ω–µ—Ç–∞ –±–ª–∏–∂–∞–π—à–∞—è –∫ –°–æ–ª–Ω—Ü—É?", a: ["–í–µ–Ω–µ—Ä–∞", "–ú–µ—Ä–∫—É—Ä–∏–π", "–ú–∞—Ä—Å"], c: 1 }
    ]
};

function createMatrix(w, h) {
    const matrix = [];
    while(h--) matrix.push(new Array(w).fill(0));
    return matrix;
}

function createPiece(type) {
    if(type === 'I') return [[0, 5, 0, 0], [0, 5, 0, 0], [0, 5, 0, 0], [0, 5, 0, 0]];
    if(type === 'L') return [[0, 6, 0], [0, 6, 0], [0, 6, 6]];
    if(type === 'J') return [[0, 7, 0], [0, 7, 0], [7, 7, 0]];
    if(type === 'O') return [[4, 4], [4, 4]];
    if(type === 'Z') return [[1, 1, 0], [0, 1, 1], [0, 0, 0]];
    if(type === 'S') return [[0, 2, 2], [2, 2, 0], [0, 0, 0]];
    if(type === 'T') return [[0, 3, 0], [3, 3, 3], [0, 0, 0]];
}

function startGame(mode) {
    document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active'));
    document.getElementById('game-wrapper').classList.remove('shake');
    
    arena = createMatrix(12, 20);  // 12 –∫–æ–ª–æ–Ω–æ–∫ –≤–º–µ—Å—Ç–æ 10
    player.score = 0;
    timerVal = mode === 'timer' ? 300 : -1;
    
    updateScore();
    nextPiece = createPiece('ILJOTSZ'[Math.random() * 7 | 0]);
    playerReset();
    
    isPaused = false;
    gameActive = true;
    lastTime = 0;
    dropCounter = 0;
    
    if(timerRef) clearInterval(timerRef);
    
    if(mode === 'timer') {
        updateTimer();
        timerRef = setInterval(() => {
            if(!isPaused && gameActive) {
                timerVal--;
                updateTimer();
                if(timerVal <= 0) endGame(true);
            }
        }, 1000);
    } else {
        document.getElementById('time-val').innerText = "‚àû";
    }
    
    update();
}

function playerReset() {
    player.matrix = nextPiece;
    nextPiece = createPiece('ILJOTSZ'[Math.random() * 7 | 0]);
    player.pos.y = 0;
    player.pos.x = (arena[0].length / 2 | 0) - (player.matrix[0].length / 2 | 0);
    
    drawNext();
    
    if(collide(arena, player)) {
        endGame(false);
    }
}

function drawNext() {
    nextCtx.clearRect(0, 0, nextCvs.width, nextCvs.height);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–≥—É—Ä—ã
    const offsetX = (nextCvs.width / 20 - nextPiece[0].length) / 2;
    const offsetY = (nextCvs.height / 20 - nextPiece.length) / 2;
    
    nextPiece.forEach((row, y) => {
        row.forEach((value, x) => {
            if(value !== 0) drawBlock(nextCtx, x + offsetX, y + offsetY, value, 20);
        });
    });
}

function collide(arena, player) {
    const [m, o] = [player.matrix, player.pos];
    for(let y = 0; y < m.length; ++y) {
        for(let x = 0; x < m[y].length; ++x) {
            if(m[y][x] !== 0 && (arena[y + o.y] && arena[y + o.y][x + o.x]) !== 0) {
                return true;
            }
        }
    }
    return false;
}

function merge(arena, player) {
    player.matrix.forEach((row, y) => {
        row.forEach((value, x) => {
            if(value !== 0) {
                arena[y + player.pos.y][x + player.pos.x] = value;
            }
        });
    });
}

function arenaSweep() {
    let rowsToClear = [];
    outer: for(let y = arena.length - 1; y > 0; --y) {
        for(let x = 0; x < arena[y].length; ++x) {
            if(arena[y][x] === 0) continue outer;
        }
        rowsToClear.push(y);
    }
    
    if(rowsToClear.length > 0) {
        isPaused = true;
        showQuiz(rowsToClear);
    }
}

function update(time = 0) {
    if(!gameActive) return;
    
    if(!isPaused) {
        const deltaTime = time - lastTime;
        lastTime = time;
        dropCounter += deltaTime;
        if(dropCounter > dropInterval) {
            playerDrop();
        }
    }

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞—Ä–µ–Ω—ã
    arena.forEach((row, y) => {
        row.forEach((value, x) => {
            if(value !== 0) drawBlock(ctx, x, y, value);
        });
    });
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–∞
    if(player.matrix) {
        player.matrix.forEach((row, y) => {
            row.forEach((value, x) => {
                if(value !== 0) drawBlock(ctx, x + player.pos.x, y + player.pos.y, value);
            });
        });
    }
}

function playerDrop() {
    player.pos.y++;
    if(collide(arena, player)) {
        player.pos.y--;
        merge(arena, player);
        SFX.drop();
        playerReset();
        arenaSweep();
        dropCounter = 0;
    } else {
        dropCounter = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è
    }
}

function playerMove(dir) {
    player.pos.x += dir;
    if(collide(arena, player)) {
        player.pos.x -= dir;
    } else {
        SFX.move();
    }
}

function playerRotate() {
    const pos = player.pos.x;
    let offset = 1;
    const matrix = player.matrix;
    
    player.matrix = matrix[0].map((val, index) => 
        matrix.map(row => row[index]).reverse()
    );
    
    while(collide(arena, player)) {
        player.pos.x += offset;
        offset = -(offset + (offset > 0 ? 1 : -1));
        if(offset > player.matrix[0].length) {
            player.matrix = matrix;
            player.pos.x = pos;
            return;
        }
    }
    
    SFX.rotate();
}

/* --- 4. UI –ò –ö–í–ò–ó --- */
function showQuiz(rows) {
    const q = CONFIG.questions[Math.floor(Math.random() * CONFIG.questions.length)];
    const overlay = document.getElementById('quiz-overlay');
    const container = document.getElementById('q-options');
    
    document.getElementById('q-text').innerText = q.q;
    container.innerHTML = '';
    
    q.a.forEach((ans, idx) => {
        const div = document.createElement('div');
        div.className = 'quiz-opt';
        div.innerText = ans;
        div.onclick = () => handleAnswer(idx === q.c, rows);
        container.appendChild(div);
    });
    
    overlay.classList.add('active');
}

function handleAnswer(isCorrect, rows) {
    document.getElementById('quiz-overlay').classList.remove('active');
    
    if(isCorrect) {
        SFX.clear();
        
        // –£–¥–∞–ª—è–µ–º –ª–∏–Ω–∏–∏ —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º
        rows.sort((a, b) => a - b).forEach(y => {
            arena.splice(y, 1);
            arena.unshift(new Array(12).fill(0));  // 12 –∫–æ–ª–æ–Ω–æ–∫
            
            // –§–µ–π–µ—Ä–≤–µ—Ä–∫–∏ –ø–æ –≤—Å–µ–π —à–∏—Ä–∏–Ω–µ –ª–∏–Ω–∏–∏
            for(let i = 0; i < 3; i++) {
                setTimeout(() => {
                    createFirework(
                        window.innerWidth / 2 + (Math.random() - 0.5) * 400,
                        window.innerHeight / 2 + (Math.random() - 0.5) * 200,
                        COLORS[Math.floor(Math.random() * 7) + 1]
                    );
                }, i * 100);
            }
        });
        
        // –õ–µ—á–µ–Ω–∏–µ —Å–µ—Ä—ã—Ö –±–ª–æ–∫–æ–≤
        for(let y = 0; y < 20; y++) {
            for(let x = 0; x < 12; x++) {  // 12 –∫–æ–ª–æ–Ω–æ–∫
                if(arena[y][x] === -1) arena[y][x] = 0;
            }
        }
        
        player.score += rows.length * 100;
        updateScore();
        
    } else {
        SFX.error();
        
        // –≠—Ñ—Ñ–µ–∫—Ç —Ç—Ä—è—Å–∫–∏
        const wrapper = document.getElementById('game-wrapper');
        wrapper.classList.remove('shake');
        void wrapper.offsetWidth;
        wrapper.classList.add('shake');
        
        // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –∫–∞–º–µ–Ω—å
        rows.forEach(y => {
            for(let x = 0; x < 12; x++) arena[y][x] = -1;  // 12 –∫–æ–ª–æ–Ω–æ–∫
        });
    }
    
    isPaused = false;
}

function updateScore() {
    document.getElementById('score-val').innerText = player.score;
}

function updateTimer() {
    if(timerVal < 0) return;
    const m = Math.floor(timerVal / 60);
    const s = timerVal % 60;
    document.getElementById('time-val').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
}

function endGame(win, manual = false) {
    gameActive = false;
    clearInterval(timerRef);
    
    if(manual) {
        resetToMenu();
        return;
    }
    
    const overlay = document.getElementById('result-overlay');
    const title = document.getElementById('res-title');
    const desc = document.getElementById('res-desc');
    
    document.getElementById('res-score').innerText = player.score;
    overlay.classList.add('active');
    
    if(win) {
        title.innerText = "–ü–û–ë–ï–î–ê! üéâ";
        title.style.background = "linear-gradient(135deg, #22d3ee 0%, #10b981 100%)";
        title.style.webkitBackgroundClip = "text";
        title.style.webkitTextFillColor = "transparent";
        desc.innerText = "–í—ã —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å —Å –∑–∞–¥–∞–Ω–∏–µ–º!";
        SFX.win();
        
        // –ú–∞—Å—Å–∏–≤–Ω—ã–µ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∏
        let fwCount = 0;
        const fw = setInterval(() => {
            if(!overlay.classList.contains('active') || fwCount > 20) {
                clearInterval(fw);
                return;
            }
            createFirework(
                Math.random() * window.innerWidth,
                Math.random() * window.innerHeight,
                COLORS[Math.floor(Math.random() * 7) + 1]
            );
            fwCount++;
        }, 200);
        
    } else {
        title.innerText = "GAME OVER";
        title.style.background = "linear-gradient(135deg, #f43f5e 0%, #dc2626 100%)";
        title.style.webkitBackgroundClip = "text";
        title.style.webkitTextFillColor = "transparent";
        desc.innerText = "–ü–æ–ª–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–∏–ª–æ—Å—å";
        SFX.error();
    }
}

function resetToMenu() {
    gameActive = false;
    isPaused = true;
    clearInterval(timerRef);
    document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active'));
    document.getElementById('menu-overlay').classList.add('active');
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
function input(key) {
    if(!gameActive || isPaused) return;
    if(key === 37) playerMove(-1);        // –í–ª–µ–≤–æ
    else if(key === 39) playerMove(1);     // –í–ø—Ä–∞–≤–æ
    else if(key === 40) playerDrop();      // –í–Ω–∏–∑
    else if(key === 38) playerRotate();    // –ü–æ–≤–æ—Ä–æ—Ç
    else if(key === 32) hardDrop();        // –ü—Ä–æ–±–µ–ª - –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å
}

// –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å —Ñ–∏–≥—É—Ä—ã
function hardDrop() {
    while(!collide(arena, player)) {
        player.pos.y++;
    }
    player.pos.y--;
    merge(arena, player);
    SFX.drop();
    playerReset();
    arenaSweep();
    dropCounter = 0;
}

document.addEventListener('keydown', event => {
    input(event.keyCode);
});
</script>

</body>
</html>
