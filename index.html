<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Neon Tetris Quiz Pro - Final</title>
    <style>
        :root {
            --neon-blue: #00d2ff;
            --neon-pink: #ff007f;
            --bg-dark: #02040a;
            --panel-bg: rgba(13, 17, 23, 0.8);
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Плавный фон звезд */
        #star-canvas {
            position: fixed;
            top: 0; left: 0;
            z-index: -1;
        }

        /* Основной контейнер */
        #game-container {
            display: flex;
            gap: 25px;
            padding: 25px;
            background: var(--panel-bg);
            border-radius: 20px;
            border: 1px solid rgba(0, 210, 255, 0.2);
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            position: relative;
        }

        canvas#tetris {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 2px solid #161b22;
        }

        .side-panel {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .box {
            background: rgba(22, 27, 34, 0.6);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .label { font-size: 11px; color: var(--neon-blue); letter-spacing: 1px; font-weight: bold; margin-bottom: 5px; }
        .value { font-size: 24px; font-weight: 800; text-shadow: 0 0 10px var(--neon-blue); }

        /* Кнопки */
        .btn {
            padding: 12px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            text-transform: uppercase;
        }
        .btn-main { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        .btn-exit { background: #f85149; color: white; margin-top: auto; }

        /* Оверлеи */
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(1, 4, 9, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 20px;
            visibility: hidden;
            opacity: 0;
            transition: 0.3s;
        }
        .overlay.active { visibility: visible; opacity: 1; }

        .quiz-opt {
            width: 80%;
            padding: 12px;
            margin: 6px;
            background: #161b22;
            border: 1px solid var(--neon-blue);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }
        .quiz-opt:hover { background: rgba(0, 210, 255, 0.1); }

        .shake { animation: shake 0.4s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
    </style>
</head>
<body>

<canvas id="star-canvas"></canvas>

<div id="game-container">
    <canvas id="tetris" width="240" height="480"></canvas>

    <div class="side-panel">
        <div class="box">
            <div class="label">СЛЕДУЮЩАЯ</div>
            <canvas id="next" width="80" height="80"></canvas>
        </div>
        <div class="box">
            <div class="label">ВРЕМЯ</div>
            <div id="time" class="value">05:00</div>
        </div>
        <div class="box">
            <div class="label">ОЧКИ</div>
            <div id="score" class="value">0</div>
        </div>
        <button class="btn btn-main" onclick="location.reload()">МЕНЮ</button>
        <button class="btn btn-exit">ВЫХОД</button>
    </div>

    <div id="quiz-overlay" class="overlay">
        <h2 id="q-text" style="text-align: center; padding: 20px;">Вопрос</h2>
        <div id="q-options" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
    </div>

    <div id="menu-overlay" class="overlay active">
        <h1 style="color: var(--neon-blue); text-shadow: 0 0 20px var(--neon-blue);">NEON QUIZ</h1>
        <p style="color: #8b949e;">High-end Performance Version</p>
        <button class="btn btn-main" style="width: 200px;" onclick="initGame('timer')">START SPRINT</button>
    </div>
</div>

<script>
/** --- 1. ПЛАВНЫЕ ЗВЕЗДЫ (НЕОНОВЫЙ ФОН) --- **/
const starCvs = document.getElementById('star-canvas');
const starCtx = starCvs.getContext('2d');
let stars = [];

function setupStars() {
    starCvs.width = window.innerWidth;
    starCvs.height = window.innerHeight;
    stars = Array.from({length: 150}, () => ({
        x: Math.random() * starCvs.width,
        y: Math.random() * starCvs.height,
        s: Math.random() * 1.5,
        v: Math.random() * 0.4 + 0.1 // Плавная скорость
    }));
}

function drawStars() {
    starCtx.fillStyle = '#02040a';
    starCtx.fillRect(0, 0, starCvs.width, starCvs.height);
    starCtx.fillStyle = 'white';
    stars.forEach(s => {
        starCtx.globalAlpha = 0.5;
        starCtx.beginPath();
        starCtx.arc(s.x, s.y, s.s, 0, Math.PI*2);
        starCtx.fill();
        s.y += s.v;
        if(s.y > starCvs.height) s.y = 0;
    });
    requestAnimationFrame(drawStars);
}

/** --- 2. ДВИЖОК ТЕТРИСА (ЛОГИКА) --- **/
const canvas = document.getElementById('tetris');
const ctx = canvas.getContext('2d');
const nextCvs = document.getElementById('next');
const nCtx = nextCvs.getContext('2d');

const ROWS = 20, COLS = 10, SIZE = 24;
const COLORS = [null, '#ff007f', '#00ff7f', '#00d2ff', '#ffd700', '#9d00ff', '#ff8c00', '#2188ff'];

let board = Array.from({length: ROWS}, () => Array(COLS).fill(0));
let player = { pos: {x: 0, y: 0}, matrix: null, next: null, score: 0 };
let gameActive = false, isPaused = false, timeLeft = 300;

function createPiece(t) {
    if (t === 'I') return [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];
    if (t === 'O') return [[2,2],[2,2]];
    if (t === 'T') return [[0,3,0],[3,3,3],[0,0,0]];
    if (t === 'S') return [[0,4,4],[4,4,0],[0,0,0]];
    if (t === 'Z') return [[5,5,0],[0,5,5],[0,0,0]];
    return [[0,6,0],[0,6,0],[6,6,0]];
}

function drawBlock(c, x, y, colorIdx, s = SIZE) {
    if(!colorIdx) return;
    const color = colorIdx === -1 ? '#444' : COLORS[colorIdx];
    c.shadowBlur = 10; c.shadowColor = color;
    c.fillStyle = color;
    c.fillRect(x*s+1, y*s+1, s-2, s-2);
    c.shadowBlur = 0;
    c.strokeStyle = 'rgba(255,255,255,0.2)';
    c.strokeRect(x*s+1, y*s+1, s-2, s-2);
}

function collide(b, p) {
    const [m, o] = [p.matrix, p.pos];
    for(let y=0; y<m.length; ++y) {
        for(let x=0; x<m[y].length; ++x) {
            if(m[y][x] !== 0 && (b[y+o.y] && b[y+o.y][x+o.x]) !== 0) return true;
        }
    }
    return false;
}

function resetPlayer() {
    player.matrix = player.next || createPiece('IOTSZ'[Math.random()*5|0]);
    player.next = createPiece('IOTSZ'[Math.random()*5|0]);
    player.pos = { x: 3, y: 0 };
    if(collide(board, player)) { gameActive = false; alert("GAME OVER"); location.reload(); }
    drawNext();
}

function drawNext() {
    nCtx.clearRect(0,0,80,80);
    player.next.forEach((r,y) => r.forEach((v,x) => drawBlock(nCtx, x+1, y+1, v, 20)));
}

function drop() {
    if(!gameActive || isPaused) return;
    player.pos.y++;
    if(collide(board, player)) {
        player.pos.y--;
        player.matrix.forEach((r,y) => r.forEach((v,x) => { if(v) board[y+player.pos.y][x+player.pos.x] = v; }));
        checkLines();
        resetPlayer();
    }
}

function checkLines() {
    let completed = [];
    board.forEach((r, y) => { if(r.every(v => v !== 0)) completed.push(y); });
    if(completed.length > 0) {
        isPaused = true;
        showQuiz(completed);
    }
}

function showQuiz(lines) {
    const overlay = document.getElementById('quiz-overlay');
    overlay.classList.add('active');
    document.getElementById('q-text').innerText = "Для очистки линий решите пример: 5 + 3 * 2 = ?";
    const opts = document.getElementById('q-options');
    opts.innerHTML = '';
    
    [11, 16].forEach(val => {
        let d = document.createElement('div');
        d.className = 'quiz-opt';
        d.innerText = val;
        d.onclick = () => {
            if(val === 11) {
                lines.forEach(y => { board.splice(y, 1); board.unshift(Array(COLS).fill(0)); });
                player.score += lines.length * 100;
                document.getElementById('score').innerText = player.score;
            } else {
                lines.forEach(y => board[y] = board[y].map(() => -1));
                document.getElementById('game-container').classList.add('shake');
                setTimeout(() => document.getElementById('game-container').classList.remove('shake'), 400);
            }
            overlay.classList.remove('active');
            isPaused = false;
        };
        opts.appendChild(d);
    });
}

function update() {
    if(gameActive) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        board.forEach((r,y) => r.forEach((v,x) => drawBlock(ctx, x, y, v)));
        player.matrix.forEach((r,y) => r.forEach((v,x) => drawBlock(ctx, x+player.pos.x, y+player.pos.y, v)));
    }
}

function initGame(mode) {
    document.getElementById('menu-overlay').classList.remove('active');
    gameActive = true;
    resetPlayer();
    setInterval(drop, 800);
    setInterval(update, 30);
    if(mode === 'timer') {
        setInterval(() => {
            if(!isPaused && timeLeft > 0) {
                timeLeft--;
                let m = Math.floor(timeLeft/60), s = timeLeft%60;
                document.getElementById('time').innerText = `${m}:${s<10?'0':''}${s}`;
            }
        }, 1000);
    }
}

// Управление
document.addEventListener('keydown', e => {
    if(!gameActive || isPaused) return;
    if(e.keyCode === 37) { player.pos.x--; if(collide(board, player)) player.pos.x++; }
    if(e.keyCode === 39) { player.pos.x++; if(collide(board, player)) player.pos.x--; }
    if(e.keyCode === 40) drop();
});

window.onload = () => { setupStars(); drawStars(); };
</script>
</body>
</html>
